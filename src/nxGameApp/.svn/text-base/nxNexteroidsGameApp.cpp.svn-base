#include "nxNexteroidsGameApp.hpp"

#include <arpa/inet.h>

#include <nxGameView/nxIGameView.hpp>
#include <nxGameView/nxHumanView.hpp>
#include <nxGameView/nxNetworkEventForwarder.hpp>
#include <nxGameView/nxMainMenuGameView.hpp>
#include <nxEvent/nxEventManager.hpp>
#include <nxNet/nxClientNetworkManager.hpp>
#include <nxNet/nxServerNetworkManager.hpp>

nxNexteroidsGameApp nxNexteroidsGameApp::m_Instance;

nxNexteroidsGameApp::nxNexteroidsGameApp()
	:
		nxGameApp()
{
}

nxNexteroidsGameApp::~nxNexteroidsGameApp()
{
}

nxNexteroidsGameApp& nxNexteroidsGameApp::GetInstance()
{
	static nxNexteroidsGameApp m_Instance;
	return m_Instance;
}

void nxNexteroidsGameApp::VCreateNetworkManager()
{
	if(m_Config->GetBool(NX_CONFIG_IS_CLIENT))
	{
		//TODO: Get these from file.
//		string clientAddr("tcp://*:5556");
		string clientListenAddr = m_Config->GetString(NX_CONFIG_CLIENT_LISTEN_ADDR);
//		string serverAddr("tcp://localhost:5555");
		string serverAddr = m_Config->GetString(NX_CONFIG_CLIENT_SERVER_ADDR);
		m_NetworkManager = NX_NEW nxClientNetworkManager(clientListenAddr, serverAddr);
	}
	else
	{
		int nNetPlayers = m_Config->GetInt(NX_CONFIG_N_NET_PLAYERS);
		string serverListenAddr = m_Config->GetString(NX_CONFIG_SERVER_LISTEN_ADDR);
		//TODO : Get these from config file
		//These are client publisher ips, we are going to subscribe to them.
		vector<string> clientIps = m_Config->GetVector(NX_CONFIG_SERVER_CLIENT_IPS);
//		clientIps.push_back("tcp://localhost:5556");
		m_NetworkManager = NX_NEW nxServerNetworkManager(serverListenAddr, clientIps);
	}
	m_NetworkManager->Init();
}

void nxNexteroidsGameApp::ListenForNexteroidsViewCommands(nxEventListenerPtr listener)
{
	//Events sent from client to server
    nxEventManager::GetInstance().VAddListener(listener, NX_EVENT_RemoteClient);
    nxEventManager::GetInstance().VAddListener(listener, NX_EVENT_Thrust);
    nxEventManager::GetInstance().VAddListener(listener, NX_EVENT_Steer);
    nxEventManager::GetInstance().VAddListener(listener, NX_EVENT_FireWeapon);
}

void nxNexteroidsGameApp::ListenForNexteroidsGameCommands(nxEventListenerPtr listener)
{
	//Events sent from server to client
    nxEventManager::GetInstance().VAddListener(listener, NX_EVENT_GameState);
    nxEventManager::GetInstance().VAddListener(listener, NX_EVENT_ActorDeath);
    nxEventManager::GetInstance().VAddListener(listener, NX_EVENT_ActorMoved);
    nxEventManager::GetInstance().VAddListener(listener, NX_EVENT_NewActor);
//    nxEventManager::GetInstance().VAddListener(listener, NX_EVENT_RequestNewGame);
}

unsigned nxNexteroidsGameApp::ConvertIpStringToUInt(string ip)
{
	struct sockaddr_in sa; // IPv4
	inet_pton(AF_INET, ip.c_str(), &(sa.sin_addr)); // IPv4
	return ntohl(sa.sin_addr.s_addr);
//	return (unsigned)inet_addr(ip.c_str());
}

void nxNexteroidsGameApp::VCreateGameLogicAndGameView()
{
	nxGameOptions opt;
	opt.nNetPlayers = m_Config->GetInt(NX_CONFIG_N_NET_PLAYERS);
	
	m_GameLogic = NX_NEW nxNexteroidsGameLogic(opt);

	//TODO : set game options with these values
	if(m_Config->GetBool(NX_CONFIG_IS_CLIENT))
	{
		log(NX_LOG_DEBUG,"is a client");
		nxEventListenerPtr listener ( NX_NEW nxNetworkEventForwarder() );
		ListenForNexteroidsViewCommands(listener);
		m_GameLogic->SetProxy(true);
		string ipString = m_Config->GetString(NX_CONFIG_MY_IP);
		unsigned ipInt = ConvertIpStringToUInt(ipString);
		m_GameLogic->SetIpInt(ipInt);
		m_GameLogic->VInit();

		//Hmm maybe not the best move. 
		//Figure out a way to change views and set new view to have the ipInt as its id.
//		shared_ptr<nxIGameView> gameView(NX_NEW nxNexteroidsGameView());
		shared_ptr<nxIGameView> gameView(NX_NEW nxMainMenuGameView());
		gameView->Init();
		m_GameLogic->VAddView(gameView, ipInt);

		//HACK : DON'T DO THIS!!!
//		nxEventManager::GetInstance().VAddListener(listener, NX_EVENT_ActorMoved);
//		m_GameLogic->VChangeState(NX_GS_WaitingForPlayers);
	}
	else
	{
		nxEventListenerPtr listener ( NX_NEW nxNetworkEventForwarder() );
		ListenForNexteroidsGameCommands(listener);
		m_GameLogic->SetProxy(false);
		m_GameLogic->VInit();
		log(NX_LOG_DEBUG,"is a server");

		shared_ptr<nxIGameView> gameView(NX_NEW nxMainMenuGameView());
		gameView->Init();
		m_GameLogic->VAddView(gameView, -1); //XXX: Get actor id somehow.
	}


//	shared_ptr<nxIGameView> gameView(NX_NEW nxNexteroidsGameView());

//	shared_ptr<IGameView> gameView(GCC_NEW TeapotWarsGameView());
//	game->VAddView(gameView);
}
